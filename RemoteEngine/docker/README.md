# DataStage Remote Engine using Docker

## License
[IBM DataStage as a Service Anywhere](https://www.ibm.com/support/customer/csol/terms/?ref=i126-9243-06-11-2023-zz-en)

## Limitations
1. The script might not work on Apple `M` processors as it runs x86 software via an emulation layer.
2. The script is not tested on Windows OS.

## Pre-Requisites
1. You must have DataStage provisioned on IBM cloud with an `Anywhere` plan. You can see different plans with details on https://cloud.ibm.com/catalog/services/datastage.
1. Software that must be installed on the system.
    1. `docker` or `podman`
    1. `jq`

## Requirements
1. Clone this repo: `git clone https://github.com/IBM/DataStage.git`.
    1. If you already have this repo cloned, go to the root directory and run `git pull` to get the latest changes.
1. Your IBM Cloud APIKey. The API key is required for registering the remote engine to your Cloud Pak for Data project on IBM Cloud. To generate a new apikey, open https://cloud.ibm.com in your browser.
    1. Click Manage > Access (IAM) > API keys to open the "API keys" page (URL: https://cloud.ibm.com/iam/apikeys).
    2. Ensure that My IBM Cloud API keys is selected in the View list.
    3. Click Create an IBM Cloud API key, and then specify a name and description
1. Your Encryption Key and IV. These can be generated by executing the command
    ```bash
    openssl enc -aes-256-cbc -k secret -P -md sha1
    ```
    Sample output:
    ```
    $ openssl enc -aes-256-cbc -k secret -P -md sha1
    salt=5334474DF6ECB3CC
    key=2A928E95489FCC163D46872040B9B24DC44E28A734B7681C8A3F0168F23E2A13
    iv =45990395FEB2B39C34B51D998E0E2E1B
    ```
    From this output, the `key` and `iv` are used as the Encryption Key and IV respectively.
1. Your Project ID. This is the ID of the project on Cloud Pak for Data project on IBM Cloud that you want to use with this Remote Engine instance. (If you are using the DataStage in Frankfurt datacenter then please use https://eu-de.dataplatform.cloud.ibm.com).
1. IBM Cloud Container Registry API Key. This apikey will be used to download the images needed to run Remote Engine. Currently there is no way to generate this, so it needs to be requested via IBM Cloud Support: https://cloud.ibm.com/unifiedsupport

## Usage
The `dsengine.sh` script can be invoked from the `docker` folder of this project. Note that the name in the below command can be changed form `remote_engine_name_01` to your preferred name.
```bash
# create/start a local remote engine instance
./dsengine.sh start -n 'remote_engine_name_01' \
                    -a "$IBMCLOUD_APIKEY" \
                    -e "$ENCRYPTION_KEY" \
                    -i "$ENCRYPTION_IV" \
                    -p "$IBMCLOUD_CONTAINER_REGISTRY_APIKEY" \
                    --project-id "$PROJECT_ID"

# stop a local remote engine instance
./dsengine.sh stop -n 'remote_engine_name_01'

# restart a local remote engine instance
./dsengine.sh restart -n 'remote_engine_name_01'

# cleanup a remote engine instance and its registration with DataPlatform
./dsengine.sh cleanup -n 'remote_engine_name_01' \
                      -a "$IBMCLOUD_APIKEY" \
                      --project-id "$PROJECT_ID"
```
Once the script execution has completed, this engine needs to be selected in the project settings by going to the project, navigating to `Manage` > `DataStage` and selecting the appropriate engine under the `Settings` tab > `Remote` environments.

### Optional start flags

While starting a remote engine, following optional flags can be used in addition to the ones shown above. These can be seen via the help flag on the start subcommand: `./dsengine.sh start --help`.

1. `--memory <value>`: Sets the maximum amount of memory the engine can use. The value takes a positive integer, followed by a suffix of m/M, g/G, to indicate megabytes or gigabytes. Default is `4G`.
1. `--cpu <value>`: Sets the maximum amount of cpu resources the engine can use. The value takes a positive number. Default is `2` cores.
1. `--volume-dir <value>`: Sets the directory to be used as the volume directory for persistent storage. Default location is `/tmp/docker/volumes`. The volume directory will be updated with the following top level file structure:

    ```
    <volume_dir>/scratch
    <volume_dir>/ds-storage
    <volume_dir>/<remote_engine_name>_runtime
    <volume_dir>/<remote_engine_name>_runtime/px-storage
    ```
    Once the remote engine is up and running, additional files and folders will be created inside the above folders as needed by the engine.
    If you are planning to create multiple engines on the same machine, then they should use different volume directories.
1. `--home <value>`: Sets the target IBM Cloud enviroment to either `ypprod` (Dallas datacenter - default) or `frprod` (Frankfurt datacenter). The project associated with this engine instance must be in same datacenter.
1. `--select-version`: Set to true if you want to choose a specific version of remote engine. By default, this flag is set to false and the latest version is used.
1. `--set-user <username>`: Specify the username to be used to run the container. If not set, the current user is used.


## Upgrade

Upgrade the remote engine instance to the latest version.
* Note that the `./dsengine.sh cleanup` command will cleanup the persistent storage directories, so its not recommended for an upgrade.
* The `./dsengine.sh startup` command will check if there is an existing container with the name specified, and if there is, the same container will be started.

1. Stop and remove the Remote engine
```bash
./dsengine.sh stop -n 'remote_engine_name_01'

# use the respective docker or docker equivalent command to remove the container (eg. podman, etc)
docker rm 'remote_engine_name_01'
```
2. Run the start command again to create and start the local remote engine instance.
```bash
./dsengine.sh start -n 'remote_engine_name_01' \
                    -a "$IBMCLOUD_APIKEY" \
                    -e "$ENCRYPTION_KEY" \
                    -i "$ENCRYPTION_IV" \
                    -p "$IBMCLOUD_CONTAINER_REGISTRY_APIKEY" \
                    --project-id "$PROJECT_ID"
```