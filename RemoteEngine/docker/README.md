# DataStage Remote Engine using Docker

## License
[IBM DataStage as a Service Anywhere](https://www.ibm.com/support/customer/csol/terms/?ref=i126-9243-06-11-2023-zz-en)

## Requirements
1. Clone this repo: `git clone git@github.com:IBM/DataStage.git` OR `git clone https://github.com/IBM/DataStage.git`.
    1. If you already have this repo cloned, go to the root directory and run `git pull` to get the latest changes.
1. Your IBM Cloud APIKey. This can be generated at https://cloud.ibm.com/iam/apikeys.
1. Your Encryption Key and IV. These can be generated by executing the command
    ```bash
    openssl enc -aes-256-cbc -k secret -P -md sha1
    ```
    Sample output:
    ```
    $ openssl enc -aes-256-cbc -k secret -P -md sha1
    salt=5334474DF6ECB3CC
    key=2A928E95489FCC163D46872040B9B24DC44E28A734B7681C8A3F0168F23E2A13
    iv =45990395FEB2B39C34B51D998E0E2E1B
    ```
    From this output, the `key` and `iv` are used as the Encryption Key and IV respectively.
1. Your Project ID. This is the ID of the project on https://dataplatform.cloud.ibm.com that you want to use with this Remote Engine instance. (If you are using the DataStage in Frankfurt datacenter then please use https://eu-de.dataplatform.cloud.ibm.com).
1. IBM Cloud Container Registry APIKey. This apikey will be used to download the images needed to run Remote Engine.

## Pre-Requisites
1. Software that must be installed on the system.
    1. `docker`
    1. `jq`

## Limitations
1. The docker images used in Remote Engine are x86 images, hence might not work on Apple M1/M2/M3 processors.

## Usage
The `dsengine.sh` script can be invoked from the `docker` folder of this project. Note that the name in the below command can be changed form `remote_engine_name_01` to your preferred name.
```bash
# create/start a local remote engine instance
./dsengine.sh start -n 'remote_engine_name_01' \
                    -a "$IBMCLOUD_APIKEY" \
                    -e "$ENCRYPTION_KEY" \
                    -i "$ENCRYPTION_IV" \
                    -p "$IBMCLOUD_CONTAINER_REGISTRY_APIKEY" \
                    --project-id "$PROJECT_ID"

# stop a local remote engine instance
./dsengine.sh stop -n 'remote_engine_name_01'

# restart a local remote engine instance
./dsengine.sh restart -n 'remote_engine_name_01'

# cleanup a remote engine instance and its registration with DataPlatform
./dsengine.sh cleanup -n 'remote_engine_name_01' \
                      -a "$IBMCLOUD_APIKEY" \
                      --project-id "$PROJECT_ID"
```

### Additional start flags

While starting a remote engine, following optional flags can be used in addition to the ones shown above. These can be seen via the help flag on the start subcommand: `./dsengine.sh start --help`.

1. `--memory <value>`: Sets the maximum amount of memory the engine can use. The value takes a positive integer, followed by a suffix of m/M, g/G, to indicate megabytes or gigabytes. Default is `4G`.
1. `--cpu <value>`: Sets the maximum amount of cpu resources the engine can use. The value takes a positive number. Default is `2` cores.
1. `--volume-dir <value>`: Sets the directory to be used as the volume directory for persistent storage. Default location is `/tmp/docker/volumes`. The volume directory will be updated with the following top level file structure:

    ```
    <volume_dir>/scratch
    <volume_dir>/ds-storage
    <volume_dir>/<remote_engine_name>_runtime
    <volume_dir>/<remote_engine_name>_runtime/px-storage
    ```
    Once the remote engine is up and running, additional files and folders will be created inside the above folders as needed by the engine.
1. `--home <value>`: Sets the target IBM Cloud enviroment to either ypprod (Dallas datacenter - default) or frprod (Frankfurt datacenter). Your associated project must be in the associated datacenter.


## Upgrade
Upgrade the remote engine instance to the latest version.
1. Stop and remove the Remote engine
```bash
./dsengine.sh stop -n 'remote_engine_name_01'
```
2. Create and start local remote engine instance
```bash
./dsengine.sh start -n 'remote_engine_name_01' \
                    -a "$IBMCLOUD_APIKEY" \
                    -e "$ENCRYPTION_KEY" \
                    -i "$ENCRYPTION_IV" \
                    -p "$IBMCLOUD_CONTAINER_REGISTRY_APIKEY" \
                    --project-id "$PROJECT_ID"
```